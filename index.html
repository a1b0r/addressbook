<link href="dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="dist/js/tabulator.min.js"></script>
<style>
    .input {

        border: 3px solid #ccc;
        background-color: white;
        font-family: inherit;
        font-size: inherit;
        cursor: text;
        padding: 1px 6px;
    }

    .action .add {
        font-size: 16;
        cursor: pointer;
        margin: 0;
        vertical-align: middle;
    }
</style>
<table>
    <tr>
        <td class="action">
            <P class="add">&#128427;</P>
        </td>

        <td class="input" role="textbox" name="id"> </td>
        <td class="input" role="textbox" name="name" contenteditable> </td>
        <td class="input" role="textbox" name="openingHours" contenteditable> </td>
        <td class="input" role="textbox" name="telephone" contenteditable> </td>
        <td class="input" role="textbox" name="country" contenteditable> </td>
        <td class="input" role="textbox" name="locality" contenteditable> </td>
        <td class="input" role="textbox" name="region" contenteditable> </td>
        <td class="input" role="textbox" name="code" contenteditable> </td>
        <td class="input" role="textbox" name="streetAddress" contenteditable></td>
    </tr>
</table>
<div id="example-table"></div>

<script>


    const addBook = async (book) => {
        const response = await fetch('api/addressbook', { method:'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify(book), });
        table.setData("api/addressbook");
        return response.json();
    }
    const jsonifyParentRow = (event) => {
        let row = event.target.parentElement.parentElement;
        let inputs = [].slice.call(row.querySelectorAll('.input'));
        let obj = {};
        inputs.map(inp => obj[inp.getAttribute('name')] = inp.innerText.trim());
        return obj;
        return JSON.stringify(obj);
    }

    document.querySelector('.action .add').addEventListener("click", e => addBook(jsonifyParentRow(e)), false);
    var minMaxFilterEditor = function (cell, onRendered, success, cancel, editorParams) {

        var end;

        var container = document.createElement("span");

        //create and style inputs
        var start = document.createElement("input");
        start.setAttribute("type", "number");
        start.setAttribute("placeholder", "Min");
        start.setAttribute("min", 0);
        start.setAttribute("max", 100);
        start.style.padding = "4px";
        start.style.width = "50%";
        start.style.boxSizing = "border-box";

        start.value = cell.getValue();

        function buildValues() {
            success({
                start: start.value,
                end: end.value,
            });
        }

        function keypress(e) {
            if (e.keyCode == 13) {
                buildValues();
            }

            if (e.keyCode == 27) {
                cancel();
            }
        }

        end = start.cloneNode();
        end.setAttribute("placeholder", "Max");

        start.addEventListener("change", buildValues);
        start.addEventListener("blur", buildValues);
        start.addEventListener("keydown", keypress);

        end.addEventListener("change", buildValues);
        end.addEventListener("blur", buildValues);
        end.addEventListener("keydown", keypress);


        container.appendChild(start);
        container.appendChild(end);

        return container;
    }

    //custom max min filter function
    function minMaxFilterFunction(headerValue, rowValue, rowData, filterParams) {
        //headerValue - the value of the header filter element
        //rowValue - the value of the column in this row
        //rowData - the data for the row being filtered
        //filterParams - params object passed to the headerFilterFuncParams property

        if (rowValue) {
            if (headerValue.start != "") {
                if (headerValue.end != "") {
                    return rowValue >= headerValue.start && rowValue <= headerValue.end;
                } else {
                    return rowValue >= headerValue.start;
                }
            } else {
                if (headerValue.end != "") {
                    return rowValue <= headerValue.end;
                }
            }
        }

        return true; //must return a boolean, true if it passes the filter.
    }

    let btncallback = async function (e, cell) {
        const data = cell.getData();
        const url = 'api/addressbook';
        const fetchOptions = {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        };
        const res = await fetch(url, fetchOptions);
        const ret = await res.json();
    };

    let btn = function (value, data, cell, row, options) {
        return `<button type="button" class="btn btn-sm btn-secondary">save</button>`;
    };

    var table = new Tabulator("#example-table", {
        // height:"311px",
        layout: "fitColumns",
        placeholder: "No Data Set",
        ajaxURL: "/api/addressbook",
        columns: [
            { title: "", formatter: btn, cellClick: btncallback },
            { title: "id", field: "id", sorter: "string" },
            { title: "name", field: "name", sorter: "string", editor: "input", headerFilter: "input", sorter: "string" },
            { title: "openingHours", field: "openingHours", sorter: "string" },
            { title: "telephone", field: "telephone", sorter: "string" },
            { title: "country", field: "country", sorter: "string" },
            { title: "locality", field: "locality", sorter: "string" },
            { title: "region", field: "region", sorter: "string" },
            { title: "code", field: "code", sorter: "string" },
            { title: "streetAddress", field: "streetAddress", sorter: "string" }
        ],
    });


</script>